---
title: "Third Week: Exploratory Data Analysis"
subtitle: "LaLiga Analysis"
author: "Yasmin Sarcheshmehpour"
output:
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
---

<h1 dir="RTL"> 
تمرین سری سوم: از لالیگا تا لیگ برتر
</h1>


```{r}
library(devtools)
library(dplyr)
library(ggplot2)
library(highcharter)
library(engsoccerdata)
data(package = "engsoccerdata")
```

***

<p dir="RTL">
۱. تعداد قهرمانی های تیم ها در تاریخ لالیگا  را استخراج کرده و نمودار ستونی آنها را رسم کنید.
</p>

```{r}
spain %>% filter(!is.na(hgoal)) %>%  filter(!is.na(vgoal)) %>% 
  group_by(Season) %>% 
  mutate(goal = hgoal-vgoal) %>% select(team = home, opp = visitor, goal) -> hd
hd %>%
  filter(goal>0) %>% group_by(team, Season) %>% summarise(win1=n()) -> hw
hd %>% group_by(Season) %>% 
  filter(goal==0) %>% group_by(team, Season) %>% summarise(eq1=n())  -> he

spain %>% filter(!is.na(hgoal)) %>%  filter(!is.na(vgoal)) %>% 
  group_by(Season) %>% 
  mutate(goal = vgoal-hgoal) %>% select(team = visitor, opp = home, goal) -> vd
vd %>%
  filter(goal>0) %>% group_by(Season, team) %>% summarise(win2=n())  -> vw
vd %>% group_by(Season) %>% 
  filter(goal==0) %>% group_by(team, Season) %>% summarise(eq2=n())  -> ve

tw = full_join(hw, vw)
tw[is.na(tw)] <- 0

te = full_join(he, ve)
te[is.na(te)] <- 0

ts = full_join(tw, te)

ts %>% mutate(s=3*(win1 + win2) + eq1 + eq2) %>% 
  group_by(Season) %>% select (team, Season, s) -> ts


spain %>% filter(!is.na(hgoal)) %>%  filter(!is.na(vgoal)) %>% 
  group_by(Season) %>% 
  mutate(diff=hgoal-vgoal, mg=hgoal) %>% select(team = home, opp = visitor, mg1=hgoal, vg1=vgoal) -> hd

spain %>% filter(!is.na(hgoal)) %>%  filter(!is.na(vgoal)) %>% 
  group_by(Season) %>% 
  mutate(diff=hgoal-vgoal, mg=hgoal) %>% select(team = visitor, opp = home, mg2=vgoal, vg2=hgoal) -> vd

td = full_join(hd, vd)
td %>% group_by(Season, team) %>% summarise(mg1=sum(mg1), mg2=sum(mg2), vg1=sum(vg1), vg2=sum(vg2)) -> td
td %>% group_by(Season, team) %>%  mutate(mg=mg1+mg2, vg=vg1+vg2, diff=mg-vg) %>% select(Season, team, mg, vg, diff) -> td


df = full_join(td, ts)
df[is.na(df)] <- 0
df %>% group_by(Season) %>% filter(s==max(s)) %>% group_by(Season) %>% filter(diff==max(diff)) %>% select (team, Season) -> ans

ans %>% group_by(team) %>%  summarise(score = n()) %>% select(team, score) %>% arrange(-score) -> ans
hchart(ans, "column", hcaes(x = team, y = score))

```


***

<p dir="RTL">
۲. کسل کننده ترین لیگ و تیم را بیابید.
نمودار ده تیم و ده فصل کسل کننده را رسم کنید.
</p>


```{r}
# tarife kesel konande : bishtarin mosavi
spain %>% filter(!is.na(hgoal)) %>%  filter(!is.na(vgoal)) %>% 
  mutate(goal = hgoal-vgoal) %>% select(team = home, opp = visitor, goal) -> hdt
hdt %>%
  filter(goal==0) %>% group_by(team) %>% summarise(eq1=n())  -> het

spain %>% filter(!is.na(hgoal)) %>%  filter(!is.na(vgoal)) %>% 
  mutate(goal = vgoal-hgoal) %>% select(team = visitor, opp = home, goal) -> vdt
vdt %>% 
  filter(goal==0) %>% group_by(team) %>% summarise(eq2=n())  -> vet
tet = full_join(he, ve)
tet[is.na(tet)] <- 0
tet %>% mutate(score=eq1 + eq2) %>% select(score, team) %>% arrange(-score) %>% head(10) -> tet
hchart(tet, "scatter", hcaes(x = team, y = score))


spain %>% filter(!is.na(hgoal)) %>%  filter(!is.na(vgoal)) %>% 
  group_by(Season) %>% 
  mutate(goal = hgoal-vgoal) %>% select(team = home, opp = visitor, goal) -> hdl
hdl %>% group_by(Season) %>% 
  filter(goal==0) %>% group_by(Season) %>% summarise(score=n()) %>% arrange(-score) %>% head(10) -> hel
hchart(hel, "scatter", hcaes(x = Season, y = score))

```

***

<p dir="RTL">
۳. در چند درصد موارد قهرمان نیم فصل در پایان فصل قهرمان شده است؟
</p>


```{r}

spain %>%
  filter(tier == 1) -> PremierLeague
rbind(
  PremierLeague %>%
    select(Season, team = home, opp = visitor, GF = hgoal, GA = vgoal, Date),
  PremierLeague %>%
    select(Season, team = visitor, opp = home, GF = vgoal, GA = hgoal, Date)
) %>% 
  mutate(GD = GF-GA) %>%
  group_by(team,Season) %>% 
  summarize(GP = n(),
            goalsF = sum(GF),
            goalsA = sum(GA),
            goaldif = sum(GD),
            W = sum(GD>0),
            D = sum(GD==0),
            L = sum(GD<0),
  ) %>% 
  mutate(score = W*3 + D) %>%
  arrange(Season,desc(score)) %>% 
  group_by(Season) %>% 
  mutate(rank = rank(-score) %>% as.integer()) -> table
table %>% 
  group_by(Season) %>% filter(score==max(score)) %>% group_by(Season) %>%
  filter(goaldif==max(goaldif)) %>% select(Season, team=team) -> ans


spain %>%
  filter(tier == 1) -> PremierLeague
rbind(
  PremierLeague %>%
    select(Season, team = home, opp = visitor, GF = hgoal, GA = vgoal, Date),
  PremierLeague %>%
    select(Season, team = visitor, opp = home, GF = vgoal, GA = hgoal, Date)
) %>% 
  mutate(GD = GF-GA) %>%
  group_by(Season) %>%
  arrange(Date) %>%
  mutate(sahel=row_number()) %>%
  filter(sahel<=max(sahel)/2) %>% 
  group_by(team,Season) %>% 
  summarize(GP = n(),
            goalsF = sum(GF),
            goalsA = sum(GA),
            goaldif = sum(GD),
            W = sum(GD>0),
            D = sum(GD==0),
            L = sum(GD<0),
  ) %>% 
  mutate(score = W*3 + D) %>%
  arrange(Season,desc(score)) %>% 
  group_by(Season) %>% 
  mutate(rank = rank(-score) %>% as.integer()) -> htable
htable %>% 
  group_by(Season) %>% filter(score==max(score)) %>% group_by(Season) %>%
  filter(goaldif==max(goaldif)) %>% select(Season, team1=team) -> hans

last = full_join(ans, hans)
similar=0
all = 0.0
for (i in 1:nrow(last)){
  if (last[i, 'team'] == last[i, 'team1']){
    similar = similar + 1
  }
  all = all + 1
}

print(similar/all * 100)

```

***

<p dir="RTL">
۴. در بین سال های ۲۰۰۱ تا ۲۰۱۰ گربه سیاه تیم های بزرگ چه تیم هایی بوده است؟
</p>

```{r}

spain %>% filter(!is.na(hgoal)) %>%  filter(!is.na(vgoal)) %>% 
  group_by(Season) %>% 
  mutate(goal = hgoal-vgoal) %>% select(team = home, opp = visitor, goal) -> hd
hd %>%
  filter(goal>0) %>% group_by(team, Season) %>% summarise(win1=n()) -> hw
hd %>% group_by(Season) %>% 
  filter(goal==0) %>% group_by(team, Season) %>% summarise(eq1=n())  -> he

spain %>% filter(!is.na(hgoal)) %>%  filter(!is.na(vgoal)) %>% 
  group_by(Season) %>% 
  mutate(goal = vgoal-hgoal) %>% select(team = visitor, opp = home, goal) -> vd
vd %>%
  filter(goal>0) %>% group_by(Season, team) %>% summarise(win2=n())  -> vw
vd %>% group_by(Season) %>% 
  filter(goal==0) %>% group_by(team, Season) %>% summarise(eq2=n())  -> ve

tw = full_join(hw, vw)
tw[is.na(tw)] <- 0

te = full_join(he, ve)
te[is.na(te)] <- 0

ts = full_join(tw, te)

ts %>% mutate(s=3*(win1 + win2) + eq1 + eq2) %>% 
  group_by(Season) %>% select (team, Season, s) -> ts


spain %>% filter(!is.na(hgoal)) %>%  filter(!is.na(vgoal)) %>% 
  group_by(Season) %>% 
  mutate(diff=hgoal-vgoal, mg=hgoal) %>% select(team = home, opp = visitor, mg1=hgoal, vg1=vgoal) -> hd

spain %>% filter(!is.na(hgoal)) %>%  filter(!is.na(vgoal)) %>% 
  group_by(Season) %>% 
  mutate(diff=hgoal-vgoal, mg=hgoal) %>% select(team = visitor, opp = home, mg2=vgoal, vg2=hgoal) -> vd

td = full_join(hd, vd)
td %>% group_by(Season, team) %>% summarise(mg1=sum(mg1), mg2=sum(mg2), vg1=sum(vg1), vg2=sum(vg2)) -> td
td %>% group_by(Season, team) %>%  mutate(mg=mg1+mg2, vg=vg1+vg2, diff=mg-vg) %>% select(Season, team, mg, vg, diff) -> td

df = full_join(td, ts)
df[is.na(df)] <- 0
df %>% group_by(Season) %>% filter(s==max(s)) %>% group_by(Season) %>% filter(diff==max(diff)) %>% select (team, Season, s) -> ans

ans %>% 
  filter('2001' <= Season) %>% filter(Season <= '2010') %>%  
  group_by(team) %>%  summarise(score = n()) %>% select(team, score) %>% arrange(-score) %>% select(team, score) -> ans
best_team = head(ans, 1)
best_team[[1]]


spain %>% 
  filter('2001' <= Season) %>% filter(Season <= '2010') %>% 
  filter(home==best_team[[1]]) %>% mutate(s=vgoal-hgoal) %>% filter(s>0) %>% 
  group_by(visitor) %>% summarise(score1=n()) %>% 
  select(team=visitor, score1)-> black_cat1

spain %>% 
  filter('2001' <= Season) %>% filter(Season <= '2010') %>% 
  filter(visitor==best_team[[1]]) %>% mutate(s=hgoal-vgoal) %>% filter(s>0) %>% 
  group_by(home) %>% summarise(score2=n()) %>% select(team=home, score2) -> black_cat2

black_cat = full_join(black_cat1, black_cat2)

black_cat[is.na(black_cat)] <- 0
black_cat %>% group_by(team) %>% mutate(score=score1+score2) %>% select(team, score) %>% arrange(-score) -> black_cat
black_cat

```

***

<p dir="RTL">
۵. در تاریخ لالیگا کدام تیم رکورددار زودترین قهرمانی است؟
همچنین کدام تیم مقتدرانه ترین قهرمانی را داشته است؟
</p>


```{r}

#moqtaderane tarin
spain %>% filter(!is.na(hgoal)) %>%  filter(!is.na(vgoal)) %>% 
  group_by(Season) %>% 
  mutate(goal = hgoal-vgoal) %>% select(team = home, opp = visitor, goal) -> hd
hd %>%
  filter(goal>0) %>% group_by(team, Season) %>% summarise(win1=n()) -> hw
hd %>% group_by(Season) %>% 
  filter(goal==0) %>% group_by(team, Season) %>% summarise(eq1=n())  -> he

spain %>% filter(!is.na(hgoal)) %>%  filter(!is.na(vgoal)) %>% 
  group_by(Season) %>% 
  mutate(goal = vgoal-hgoal) %>% select(team = visitor, opp = home, goal) -> vd
vd %>%
  filter(goal>0) %>% group_by(Season, team) %>% summarise(win2=n())  -> vw
vd %>% group_by(Season) %>% 
  filter(goal==0) %>% group_by(team, Season) %>% summarise(eq2=n())  -> ve

tw = full_join(hw, vw)
tw[is.na(tw)] <- 0

te = full_join(he, ve)
te[is.na(te)] <- 0

ts = full_join(tw, te)

ts %>% mutate(s=3*(win1 + win2) + eq1 + eq2) %>% 
  group_by(Season) %>% select (team, Season, s) -> ts


spain %>% filter(!is.na(hgoal)) %>%  filter(!is.na(vgoal)) %>% 
  group_by(Season) %>% 
  mutate(diff=hgoal-vgoal, mg=hgoal) %>% select(team = home, opp = visitor, mg1=hgoal, vg1=vgoal) -> hd

spain %>% filter(!is.na(hgoal)) %>%  filter(!is.na(vgoal)) %>% 
  group_by(Season) %>% 
  mutate(diff=hgoal-vgoal, mg=hgoal) %>% select(team = visitor, opp = home, mg2=vgoal, vg2=hgoal) -> vd

td = full_join(hd, vd)
td %>% group_by(Season, team) %>% summarise(mg1=sum(mg1), mg2=sum(mg2), vg1=sum(vg1), vg2=sum(vg2)) -> td
td %>% group_by(Season, team) %>%  mutate(mg=mg1+mg2, vg=vg1+vg2, diff=mg-vg) %>% 
  select(Season, team, mg, vg, diff) -> td


df = full_join(td, ts)
df[is.na(df)] <- 0
df %>% group_by(Season) %>% filter(s==max(s)) %>% group_by(Season) %>% filter(diff==max(diff)) %>% 
  group_by(team) %>% summarise(score=sum(s)) %>% arrange(-score)-> ans
ans

```

***

<p dir="RTL">
۶. طولانی ترین نوار پیروزی مساوی و شکست مال چه تیم هایی است؟
</p>


```{r}

seasons = unique(spain$Season)
win = 0
win_team = ''
fail = 0
fail_team = ''
equal = 0
equal_team = ''
for (season in seasons){
  spain %>% filter(Season==season) %>% select(home, visitor, hgoal, vgoal, Date)-> data
  teams = unique(data$home)
  for (team in teams){
    piroozi = 0
    shekast = 0
    mosavi = 0
    prev = 0
    data %>% filter(home==team)%>%
      mutate(diff=hgoal-vgoal) %>% select(Date, diff) -> d1
    data %>% filter(visitor==team)%>% 
      mutate(diff=hgoal-vgoal) %>% select(Date, diff)-> d2
    rbind(d1, d2) %>% arrange(Date) -> d
    if (nrow(d) == 0)
      next
    for (i in 1:nrow(d)){
      dif = d[i, 'diff']
      if (i == 1){
        if (dif > 0){
          prev = 1
          piroozi = 1
        }
        else if(dif == 0){
          prev = 0
          mosavi = 1
        }
        else{
          prev = -1
          shekast = 1
        }
      }
      if (dif > 0){
        if (prev > 0){
          piroozi = piroozi + 1
        }
        else{
          if (shekast > fail){
            fail = shekast
            fail_team = team
          }
          if(mosavi > equal){
            equal = mosavi
            equal_team = team
          }
          prev = 1
          piroozi = 1
          shekast = 0
          mosavi = 0
        }
      }
      if (dif == 0){
        if (prev == 0){
          mosavi = mosavi + 1
        }
        else{
          if (shekast > fail){
            fail = shekast
            fail_team = team
          }
          if(piroozi > win){
            win = piroozi
            win_team = team
          }
          prev = 0
          piroozi = 0
          shekast = 0
          mosavi = 1
        }
      }
      if (dif < 0){
        if (prev < 0){
          shekast = shekast + 1
        }
        else{
          if(mosavi > equal){
            equal = mosavi
            equal_team = team
          }
          if(piroozi > win){
            win = piroozi
            win_team = team
          }
          prev = -1
          piroozi = 0
          shekast = 1
          mosavi = 0
        }
      }
    }
  }
}
win
win_team
equal
equal_team
fail
fail_team



```

***

<p dir="RTL">
۹. جدولی مشابه بالا برای فصل ۲۰۱۲ از  کل نتایج طراحی کنید.
</p>


```{r}

spain %>%
  filter(tier==1) %>%
  filter(Season==2012) %>% arrange(Date) %>%
  select(home,visitor,FT) -> df

ggplot(data = df, aes(x=home, y=visitor)) + 
  geom_tile() + geom_text(aes(home, visitor, label = FT), color = "white") +
  theme(
    axis.text.x = element_text(angle = 90),
    legend.direction = "vertical") + guides(fill = guide_colorbar())

```

***

<p dir="RTL">
۱۰. سه آماره به همراه نمودار فردوسی پسند استخراج کنید.
</p>



```{r}

# nemoodare emtiaze Real Madrid
spain %>%
  filter(tier == 1) -> PremierLeague
rbind(
  PremierLeague %>%
    select(Season, team = home, opp = visitor, GF = hgoal, GA = vgoal),
  PremierLeague %>%
    select(Season, team = visitor, opp = home, GF = vgoal, GA = hgoal)
) %>% filter(team=='Real Madrid') %>% 
  mutate(D=GF-GA) %>% 
  mutate(S2 = ifelse(D > 0,3,0)) %>% 
  mutate(S1 = ifelse(D == 0,1,0)) %>% 
  mutate(s=S1+S2) %>%
  group_by(team, Season) %>% summarise(score=sum(s)) -> real_data
hchart(real_data, "scatter", hcaes(x = Season, y = score))


#nemoodare zaeif tarin team ha
spain %>%
  filter(tier == 1) -> PremierLeague
rbind(
  PremierLeague %>%
    select(Season, team = home, opp = visitor, GF = hgoal, GA = vgoal, Date),
  PremierLeague %>%
    select(Season, team = visitor, opp = home, GF = vgoal, GA = hgoal, Date)
) %>% 
  mutate(GD = GF-GA) %>%
  group_by(team,Season) %>% 
  summarize(GP = n(),
            goalsF = sum(GF),
            goalsA = sum(GA),
            goaldif = sum(GD),
            W = sum(GD>0),
            D = sum(GD==0),
            L = sum(GD<0),
  ) %>% 
  mutate(score = W*3 + D) %>%
  arrange(Season,desc(score)) %>% 
  group_by(Season) %>% 
  mutate(rank = rank(-score) %>% as.integer()) -> table
table %>%
  group_by(Season) %>% filter(score==min(score)) %>% group_by(Season) %>%
  filter(goaldif==min(goaldif)) %>% group_by(team) %>%  summarise(count=n()) -> ans
ans
hchart(ans, "column", hcaes(x = team, y = count))


# majmoe gol haye zade shode dar har season
spain %>%
  filter(tier == 1) -> PremierLeague
rbind(
  PremierLeague %>%
    select(Season, team = home, opp = visitor, GF = hgoal, GA = vgoal, Date),
  PremierLeague %>%
    select(Season, team = visitor, opp = home, GF = vgoal, GA = hgoal, Date)
) %>% 
  mutate(GD = GF-GA) %>%
  group_by(team,Season) %>% 
  summarize(GP = n(),
            goalsF = sum(GF),
            goalsA = sum(GA),
            goaldif = sum(GD),
            W = sum(GD>0),
            D = sum(GD==0),
            L = sum(GD<0),
  ) %>% 
  mutate(score = W*3 + D) %>%
  arrange(Season,desc(score)) %>% 
  group_by(Season) %>% 
  mutate(rank = rank(-score) %>% as.integer()) -> table
table %>% group_by(Season) %>% 
  summarise(score=sum(goalsF)+sum(goalsA)) -> ans
hchart(ans, "scatter", hcaes(x = Season, y = score))

```